---
lab:
    title: '探索 Azure 网络安全组 (NSG)'
    module: '模块 3 第 1 课：描述 Microsoft 安全解决方案的功能：Azure 基本安全功能介绍。'
---


# 实验室：探索 Azure 网络安全组 (NSG)。

## 实验室场景
在本实验室中，你将探索 Azure 中网络安全组的功能。  你将通过创建不带任何网络安全组 (NSG) 的 VM 来实现此目的。  没有任何 NSG 来筛选流量，VM 中的所有端口都将对公共 Internet 公开。  然后，你将完成创建 NSG 并将 VM 的接口分配给该 NSG 的过程。  配置完成后，需使用默认 NSG 规则以及你将创建的规则测试到 VM 的连接。
  

**预计用时**：15-20 分钟

#### 任务 1：  在此任务中，你将创建一个 Windows 10 虚拟机。    
1.	打开 Microsoft Edge。  在地址栏中，输入 **“portal.azure.com”**。

1. 使用管理员凭据登录。
    1. 在“登录”窗口中，输入 **“admin@WWLxZZZZZZ.onmicrosoft.com”** （其中，ZZZZZZ 是实验室托管提供商提供的唯一租户 ID），然后选择 **“下一步”**。

    1. 输入管理员密码，该密码应由实验室托管提供商提供。选择 **“登录”**。
    1. 在提示保持登录状态时，选择 **“是”**。
1. 在屏幕左上角显示 Microsoft Azure 的位置旁边，选择“显示门户菜单”图标（这三条水平线也称为汉堡图标），然后选择 **“所有服务”**。  
1. 在主窗口的“精选”下，选择“虚拟机”。  如果未看到虚拟机列出，请在搜索栏中输入“虚拟机”，然后从搜索结果中进行选择。
1. 在页面左上角，选择 **“+ 创建”**，然后选择 **“+ 虚拟机”**。
1. 在“基本”选项卡中，填写以下信息（对于未列出的任何内容，保留默认设置）：
    1. 订阅：验证默认设置是否为“Azure Pass - 赞助”。

    1. 资源组：  选择 **“新建”**，在“名称”字段输入 **“LabsSC900”**，然后选择 **“确定”**。
    1. 虚拟机名称：  输入 **“SC900-WinVM”**。
    1. 映像：  从下拉列表中选择 **“Windows 10 Pro，版本 20H2 - Gen 1”**。
    1. 大小：  从下拉列表中选择 **“查看所有大小”**，选择 **“B2s”**，然后按页面底部的 **“选择”**。
    1. 用户名：  输入 **“AzureUser”**。
    1. 密码：  输入 **“SC900AzureLabs”**。
    1. 公共入站端口：  选择 **“无”**。
    1. 许可：  选择 **“我确认我拥有符合条件的具有多租户托管权限的 Windows 10 许可证”**，这样框中就会出现复选标记。
    1. 选择 **“下一步: 磁盘”**。 
1. 你现在位于用于配置 VM 的“磁盘”选项卡。  将所有设置保留为默认值，然后选择 **“下一步: 网络 >”**。
1. 你现在位于用于配置 VM 的“网络”选项卡。  填写以下信息（对于未列出的任何内容，保留默认设置）：
    1. NIC 网络安全组：  选择 **“无”**。

    1. 选择 **“下一步: 管理 >”**。
1. 你现在位于用于配置 VM 的“管理”选项卡。  将所有设置保留为默认值，然后选择 **“下一步: 高级 >”**。
1. 你现在位于用于配置 VM 的“高级”选项卡。  将所有设置保留为默认值，然后选择 **“下一步: 标记 >”**。
1. 你现在位于用于配置 VM 的“标记”选项卡。  将所有设置保留为默认值，然后选择 **“下一步: 查看 + 创建 >”**。
1. 查看 VM 的配置。  需要注意的一些事项：此 VM 有一个公共 IP 地址，没有 NIC 网络安全组。  从安全性角度来看，这会使 VM 易受攻击。  我们将在后续任务中解决此问题。选择“创建”。  完成 VM 部署可能需要几分钟时间。
1. 记下网络接口的名称 **“sc900-winvmXXX”** （XXX 将特定于 VM 的网络接口）。
1. VM 部署完成后，选择 **“转到资源”**。
1. 现在位于“SC900-WinVM”页面。  记下公共 IP 地址。 
1. 从页面顶部选择 **“连接”**，然后从下拉列表中选择 **“RDP”**。
1. 验证 IP 地址是否已设置为“公共 IP 地址”，保留默认端口号，然后选择 **“下载 DRP 文件”**。 
1. 打开下载的文件，然后选择 **“连接”**。 
1. 系统会提示输入凭据。  对于用户名，输入 **“AzureUser”**。  对于密码，输入 **“SC900AzureLabs”**。 
1. 此时会打开一个“远程桌面连接”窗口，显示“无法验证远程计算机的身份。  仍要连接吗?”  选择 **“是”**。
1. 现已连接到刚创建的 Windows VM。按照提示完成 Windows 设置。尽管你已通过 RDP 和常用的 RDP 端口连接到 VM，但此 VM 的所有端口都是打开的，没有筛选流量的项。 
1. 通过选择显示 IP 地址的页面顶部中心的 **“X”**，关闭远程桌面连接。  此时会出现一个弹出窗口，显示“将断开远程会话连接”。选择 **“确定”**。
1. 现已返回 Azure 门户的“SC900-WinVM”页面。  将此浏览器选项卡保持在打开状态，便于进行下一个任务。

#### 任务 2：  创建一个网络安全组，并将 VM 的网络接口分配给该 NSG。

1. 在浏览器中打开“SC900-WinVM - Microsoft Azure”选项卡。

1. 在页面左上角显示 Microsoft Azure 的位置旁边，选择“显示门户菜单”图标（这三条水平线也称为汉堡图标），然后选择 **“所有服务”**。
1. 在显示“所有服务”旁边的“筛选服务”框中，输入 **“网络安全组”**，然后从结果中选择 **“网络安全组”** （不要选择“网络安全组(经典)”）。
1. 在“网络安全组”页面顶部，选择 **“+ 创建”**。
1. 在“创建网络安全组”页面的“基本”选项卡上，指定以下设置：
    1. 订阅：  Azure Pass - 赞助

    1. 资源组：  **LabsSC900**
    1. 名称：  **NSG-SC900**
    1. 区域：  保留默认值 **“(美国)美国东部”**
    1. 选择 **“查看 + 创建”**，然后选择 **“创建”**。
1. 部署完成后，选择 **“转到资源”**。
1. 请注意 NSG 中的默认入站和出站规则。  虽然已创建了 NSG，并且存在用于筛选流量的默认规则，但没有任何接口与 NSG 关联，因此 VM 的所有端口都对公共 Internet 公开，从而仍易受到攻击。
1. 在“NSG-SC900”页面的左侧导航窗格中，选择“设置”下的 **“网络接口”**。
1. 选择搜索框上方的 **“+ 关联”**。
1. 在“关联网络接口”页面中，选择 **“sc900-winvmXXX”** （XXX 将特定于 VM 的网络接口）。  关联接口时，你会看到屏幕右上角有一个通知框。
1. 将接口关联到 NSG 后，它会显示在列表中。
1. 使用与网络安全组关联的 VM 接口和默认 NSG 规则，任何尝试连接到 VM 的操作都应会失败。  
1. 在页面左上角选择 **“所有服务”**，然后在显示“精选”的位置下方，选择 **“虚拟机”**。
1. 在“虚拟机”页面上，选择 **“SC900-WinVM”**。
1. 在 **“SC900-WinVM”** 页面顶部，选择 **“连接”**，然后选择 **“RDP”**。
1. 验证 IP 地址是否已设置为“公共 IP 地址”，保留默认端口号，然后选择 **“下载 DRP 文件”**。
1. 打开下载的文件，然后选择 **“连接”**。
1. 尝试连接几秒钟后，你会看到失败消息，显示“远程桌面无法连接到远程计算机”。  选择 **“确定”**。

#### 任务 3：在此任务中，你将创建一个 NSG 规则，允许端口 3389 上使用 RDP 的入站流量。  然后，你将通过尝试使用 RDP 连接到 VM 来测试该规则。 

1. 在浏览器中打开“SC900-WinVM - Microsoft Azure”选项卡。

1. 在左侧导航面板的“设置”下，选择 **“网络”**。
1. 选中“入站端口规则”选项卡后，你将看到默认入站规则。不能删除默认规则，但可通过创建优先级更高的规则来替代默认规则。在页面右侧，选择 **“添加入站端口规则”**：
1. 在“添加入站安全规则”页面上，指定以下设置：
    1. 源：  **任何**

    1. 源端口范围： *
    1. 目标：  **任何**
    1. 服务：  **RDP**
    1. 操作：  **允许**
    1. 优先级：  **300**；备注：带有更小数字的规则具有更高的优先级，会先进行处理。
    1. 名称：  **AllowRDP**
1. 选择 **“添加”**
1. 预配规则后，它将显示在入站规则列表中。
1. 现在，验证是否能够使用 RDP 连接到 VM。  从左侧导航面板中选择 **“连接”**。
1. 验证 IP 地址是否已设置为“公共 IP 地址”，保留默认端口号，然后选择 **“下载 DRP 文件”**。
1. 打开下载的文件，然后选择 **“连接”**。
1. 系统会提示输入凭据。  对于用户名，输入 **“AzureUser”**。  对于密码，输入 **“SC900AzureLabs”**。
1. 此时会打开一个“远程桌面连接”窗口，显示“无法验证远程计算机的身份。  仍要连接吗?”  选择 **“是”**。
1. 现在已连接到 VM。在本例中，你能够连接到 VM，因为创建的入站流量规则允许入站流量通过 RDP 流入 VM。
1. 请将 VM 保持在打开状态，在下一个任务中将用到它。

#### 任务 4：  NSG 的默认出站规则允许出站 Internet 流量，因此你将验证是否可以连接到 Internet。  然后，你将完成创建自定义出站规则以阻止出站 Internet 流量并测试该规则的过程。

1. 从 VM 中选择 **“Edge”** 以打开浏览器。  
1. 在浏览器地址栏中输入 **https://www.bing.com** 并确认你是否能够连接到搜索引擎。
1. 关闭 VM 上的浏览器，但将 VM 保持在打开状态，因为你将在后续步骤中用到它。
1. 返回 Azure 门户，在浏览器中打开“SC900-WinVM - Microsoft Azure”选项卡。
1. 在左侧导航面板的“设置”下，选择 **“网络”**。
1. 选择 **“出站端口规则”** 选项卡。  你将看到默认出站规则。  记下默认规则“AllowInternetOutBound”。此规则允许所有出站 Internet 流量。不能删除默认规则，但可通过创建优先级更高的规则来替代默认规则。在页面右侧，选择 **“添加出站端口规则”**。
1. 在“添加出站安全规则”页面上，指定以下设置：
    1. 源：  **任何**

    1. 源端口范围：  *
    1. 目标：  **服务标记**
    1. 目标服务标记：  **Internet**
    1. 服务：  **自定义**（保留默认值）
    1. 目标端口范围：  * （确保在目标端口范围字段中加一个星号）
    1. 协议：**任何**
    1. 操作：**拒绝**
    1. 优先级：  **4000**
    1. 名称：  **DenyInternet**
1. 选择 **“添加”**
1. 预配规则后，它将显示在出站规则列表中。  虽然它显示在列表中，但需要几分钟时间才会生效（请等待几分钟，然后再继续执行后续步骤）。  
1. 返回到 VM
1. 在 VM 中打开 Edge 浏览器并输入 **https://www.bing.com** 该页面应该不会显示。备注：如果你能够连接到 Internet，并已验证正确设置了出站规则的所有参数，则很可能是因为规则需要几分钟才能生效。  关闭浏览器，等待几分钟，然后重试。
1. 通过选择显示 IP 地址的页面顶部中心的 **“X”**，关闭远程桌面连接。  此时会出现一个弹出窗口，显示“将断开远程会话连接”。选择 **“确定”**。
1. 在此任务中，你在 NSG 中成功配置了阻止出站 Internet 流量的出站规则。

#### 任务 5：  重要说明：在此任务中，你需要删除资源组及其包含的所有资源。   这对于避免产生额外费用至关重要。

1. 在浏览器中打开“SC900-WinVM - Microsoft Azure”选项卡。

1. 在页面左上角选择 **“所有服务”**。
1. 在显示所有服务旁边的“筛选服务”框中，输入 **“资源组”**，然后从结果中选择 **“资源组”**。
1. 选择 **“LabsSC900”**。
1. 在“LabsSC900”页面顶部中心选择 **“删除资源组”**。
1. 在打开的窗口中，输入资源组名称 **“LabsSC900”** 以确认删除该资源组及其所有资源，然后选择页面底部的 **“删除”**。
1. 可能需要花费几分钟时间才能删除所有资源和该资源组。

#### 回顾

在本实验室中，你完成了设置含/不含网络安全组 (NSG) 的 VM，并查看了默认 NSG 规则产生的影响。  此外，你还完成了创建 NSG 规则的过程。
