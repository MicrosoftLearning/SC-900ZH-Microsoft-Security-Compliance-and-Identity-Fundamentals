---
Demo:
    title: 'Azure 网络安全组 (NSG)'
    module: '模块 3 第 1 课：描述 Microsoft 安全解决方案的功能：Azure 基本安全功能介绍。'
---

# 演示：Azure 网络安全组 (NSG)

### 演示方案
在本演示中，你将展示 Azure 中网络安全组 (NSG) 的功能。  为此，你将首先创建不包含任何 NSG 的虚拟机 (VM) 作为预演示设置的一部分。你还将创建不包含任何关联接口或子网的 NSG。  在演示过程中，你将展示 NSG 的默认入站和出站规则。然后，你将完成将 VM 的接口分配到 NSG 的过程。  配置完成后，需使用默认 NSG 规则以及你将创建的规则测试到 VM 的连接。
  

#### 预演示设置第 1 部分
 建议讲师在上课**前**完成此操作，因为创建 VM 可能需要几分钟时间。在此设置中，需创建一个 Windows 10 虚拟机。

1. 在浏览器中打开 **“主页 - Microsoft Azure”** 选项卡。  如果之前关闭了该选项卡，请打开浏览器页面，在地址栏中输入 portal.azure.com，然后重新登录。

1. 在页面顶部显示 Microsoft Azure 旁边蓝色栏的搜索框中，输入 **“虚拟机”**，然后在搜索结果中选择 **“虚拟机”**。  

1. 在页面左上角，选择 **“+ 添加”**，然后选择 **“+ 虚拟机”**。

1. 在“基本”选项卡中，填写以下信息（对于未列出的任何内容，保留默认设置）：
    1. **订阅**：验证默认设置是否为“Azure Pass - 赞助”。
    1. **资源组**：选择 **“新建”**，在“名称”字段输入 **“LabsSC900-RG”**，然后选择 **“确定”**。
    1. **虚拟机名称**：  输入 **“SC900-WinVM”**。
    1. **区域**：  保留默认值。
    1. **可用性选项**：确保选择 **“不需要基础结构冗余”**。  备注：请务必将可用性选项设置为“不需要基础结构冗余”，否则演示将不会按预期进行。  提供可用性选项需要 NSG，我们正在特意创建不包含 NSG 的 VM。
    1. **映像**：  从下拉列表中选择 **“Windows 10 Pro，版本 20H2 - Gen 1”**。
    1. **大小**：  从下拉列表中选择 **“查看所有大小”**，选择 **“B2s”**，然后按页面底部的 **“选择”**。
    1. **用户名**：  输入 **“AzureUser”**。
    1. **密码**：  输入 **“SC900AzureLabs”**。
    1. **公共入站端口**：  可以保留默认设置（你在此处选择什么设置都不重要，因为网络设置将覆盖你在此处做出的选择）。
    1. **许可**：  选择 **“我确认我拥有符合条件的具有多租户托管权限的 Windows 10 许可证”**，这样框中就会出现复选标记。
    1. 选择 **“下一步: 磁盘”**。

1. 你现在位于用于配置 VM 的“磁盘”选项卡。  将所有设置保留为默认值，然后选择 **“下一步: 网络 >”**。

1. 你现在位于用于配置 VM 的“网络”选项卡。  填写以下信息（对于未列出的任何内容，保留默认设置）：
    1. NIC 网络安全组：  选择 **“无”**。  备注：选择“无”即表示你确定 NIC 没有 NSG。  在演示的后续步骤中，你将创建 NSG，并将 VM NIC 分配到所创建的 NSG。
    1. 由于 VM 的其他设置将保留为其默认值，因此请继续操作并选择“下一步: **查看 + 创建 >”**。

1. 查看 VM 的配置。  需要注意的一些事项：此 VM 有一个公共 IP 地址，没有 NIC 网络安全组。  从安全性角度来看，这会使 VM 易受攻击。  我们将在后续任务中解决此问题。选择 **“创建”**。  完成 VM 部署可能需要几分钟时间。

1. 记下网络接口的名称 **“sc900-winvmXXX”** （XXX 将特定于 VM 的网络接口）。

1. VM 部署完成后，选择 **“转到资源”**。  现在位于“SC900-WinVM”页面。  记下公共 IP 地址。

1. 从左侧导航面板中选择 **“网络”**，记下网络接口 **“sc900-winvmXXX”** （XXX 将特定于 VM 的网络接口）。  不应存在与接口相关联的入站和出站规则。  

1. 从页面顶部选择 **“连接”**，因为验证可连接到 VM 至关重要。
    1. 从页面顶部，确保已选中 **“RDP”** （带下划线）。
    1. 验证 IP 地址是否已设置为“公共 IP 地址”，保留默认端口号，然后选择 **“下载 DRP 文件”**。
    1. **“打开”** 下载的文件，在显示的窗口中选择 **“连接”**。
    1. 随即会打开一个窗口，该窗口将提示你输入凭据。如果默认窗口请求 PIN，请选择 **“更多选择”**，然后选择 **“使用其他帐户”**。   系统会提示输入凭据。  对于用户名，输入 **“AzureUser”**。  对于密码，输入 **“SC900AzureLabs”**。
    1. 此时会打开一个“远程桌面连接”窗口，显示“无法验证远程计算机的身份。  仍要连接吗?”  选择 **“是”**。
    1. 现已连接到刚创建的 Windows VM。完成 Windows 设置。尽管你已通过 RDP 和常用的 RDP 端口连接到 VM，但此 VM 的所有端口都是打开的，没有筛选流量的项。  通过选择显示 IP 地址的页面顶部中心的 **“X”**，关闭远程桌面连接。  此时会出现一个弹出窗口，显示“将断开远程会话连接”。选择 **“确定”**。

1. 现已返回 Azure 门户的“SC900-WinVM”页面。  将此浏览器选项卡保持在打开状态，便于进行下一个任务。

#### 预演示设置第 2 部分
创建一个网络安全组，但请勿将 VM 的网络接口分配给该 NSG。  

1. 在浏览器中打开“SC900-WinVM - Microsoft Azure”选项卡。

1. 在页面顶部显示 Microsoft Azure 旁边蓝色栏的搜索框中，输入 **“网络安全组”**，然后在搜索结果中选择 **“网络安全组”**。  切勿选择“网络安全组(经典)”。

1. 在“网络安全组”页面顶部，选择 **“+ 创建”**。

1. 在“创建网络安全组”页面的“基本”选项卡上，指定以下设置：
    1. 订阅：  Azure Pass - 赞助
    1. 资源组：  **LabsSC900-RG**
    1. 名称：  **NSG-SC900**
    1. 区域：  保留默认值 **“(美国)美国东部”**
    1. 选择 **“查看 + 创建”**，然后选择 **“创建”**。

1. 部署完成后，选择 **“转到资源组”**，确保所有内容均正确。  应有 3 个默认入站规则，3 个默认出站规则，不应有任何与 NSG 相关联的子网和接口。  返回到 Azure 门户的 **“主页”**。  

#### 演示
演练 NSG 的设置。  在本例中，你将针对尚未分配到 VM 接口的现有 NSG（在上述设置中创建）进行演练。然后，你将演示将接口关联到 NSG 的过程以及创建入站和出站规则的过程。

1. 打开浏览器选项卡 **“主页 - Microsoft Azure”**。  如果之前关闭了该选项卡，请打开浏览器页面，在地址栏中输入 portal.azure.com，然后重新登录。

1. 在页面顶部显示 Microsoft Azure 旁边蓝色栏的搜索框中，输入 **“网络安全组”**，然后在搜索结果中选择 **“网络安全组”**。  切勿选择“网络安全组(经典)”。

1. 在 NSG 页面中，选择在设置阶段创建的 NSG - **“NSG-SC900”**。

1. 突出显示了左侧导航面板中的 **“概述”** 选项卡。  请注意 NSG 中的默认入站和出站规则。尽管已创建 NSG，并且没有用于筛选流量的默认规则，但尚无与 NSG 相关联的接口。可在页面右上角看到此信息，显示“已关联: 0 个子网，0 个网络接口”。  为了使 NSG 可完成此操作，需要将其分配给某个项。  在本例中，我们分配给之前创建的 VM 的网络接口。

1. 在“NSG-SC900”页面的左侧导航窗格中，选择“设置”下的 **“网络接口”**。

1. 选择搜索框上方的 **“+ 关联”**，从下拉列表中选择 **“sc900-winvmXXX”** （XXX 将特定于 VM 的网络接口），然后选择 **“确定”**。关联接口时，你会看到屏幕右上角有一个通知框。将接口关联到 NSG 后，它会显示在列表中。

1. 返回到 **“概览”** 选项卡。  请注意，页面右上角会显示“已关联: 0 个子网，1 个网络接口”- 接口现已分配到 NSG。此外，向学员强调示默认规则。对于入站，仅允许来自其他 Azure 虚拟网络和 Azure 负载均衡器的流量。将拒绝流向 VM 的所有其他入站流量。同样需注意默认出站规则。  仅允许流向其他 VNet 的出站流量和出站 Internet 流量。  在演示过程中，建议花一点时间演示入站流量被拒绝。
    1. 在页面顶部的搜索栏中，输入并选择 **“虚拟机”**。
    1. 在“虚拟机”页面上，选择 **“SC900-WinVM”**。
    1. 在“SC900-WinVM”页面顶部，选择 **“连接”**，然后选择 **“RDP”**。
    1. 验证 IP 地址是否已设置为“公共 IP 地址”，保留默认端口号，然后选择 **“下载 DRP 文件”**。
    1. **打开**下载的文件，然后选择 **“连接”**。
    1. 尝试连接几秒钟后，你会看到失败消息，显示“远程桌面无法连接到远程计算机”。选择 **“确定”**。

1. 展示 NSG 默认入站规则的影响后，你现在想要创建用于允许入站 RDP 流量的新规则。  请注意，无法删除现有默认规则，只能创建优先级更高的新规则。
    1. 在左侧导航面板的“设置”下，选择 **“网络”**。  现在位于 VM 的“网络”页面，虽然可在此处创建入站规则和出站规则，但请返回到 NSG 页面，毕竟本演示是关于 NSG。  **“选择 NSG-SC900”** 是窗口中间的链接。

1. 现在位于 NSG 概述页面。  注意关于 NSG 的信息。在“NSG”页面的左侧导航面板中，选择“设置”下的 **“入站安全规则”**，然后选择页面顶部的 **“+ 添加”**。在“添加入站安全规则”页面上，查看各种设置。实际上，建议使用以下设置创建用于允许入站 RDP 的规则：
    1. 源：**任何**
    1. 源端口范围：**\***
    1. 目标：**任何**
    1. 服务： **RDP**
    1. 操作：**允许**
    1. 优先级：**300**；备注：带有更小数字的规则具有更高的优先级，会先进行处理。因此，这一新规则的优先级需高于拒绝所有入站流量的现有规则的优先级。
    1. 名称：**AllowRDP**
    1. 选择 **“添加”**
    1. 预配规则后，它将显示在入站规则列表中。

1. 现在查看 **“出站安全规则”**。  选择页面顶部的 **“+ 添加”**，并查看各种设置。  建议使用以下设置创建用于拒绝出站 Internet 流量的规则：
    1. 源：**任何**
    1. 源端口范围：**\***
    1. 目标：**服务标记**
    1. 目标服务标记：**Internet**
    1. 服务：**自定义**（保留默认值）
    1. 目标端口范围：**\***（确保在目标端口范围字段中加一个星号）。
    1. 协议：**任何**
    1. 操作：**拒绝**
    1. 优先级：**4000**（需要指出的一点是，此优先级需高于允许 Internet 出站流量的现有规则的优先级）
    1. 名称：**DenyInternet**
    1. 选择 **“添加”**
    1. 预配规则后，它将显示在出站规则列表中。

1. 现在返回到 VM 页面并测试规则。  在页面顶部选择 **“SC900-VM”**，其上方显示出站安全规则。

1. 通过使用 RDP 验证是否可连接到 VM 来测试入站规则。
    1. 从左侧导航面板中选择 **“连接”**。
    1. 验证 IP 地址是否已设置为“公共 IP 地址”，保留默认端口号，然后选择 **“下载 DRP 文件”**。
    1. **打开**下载的文件，然后选择 **“连接”**。
    1. 系统会提示输入凭据。对于用户名，输入 **“AzureUser”**。对于密码，输入 **“SC900AzureLabs”**。  如果提示输入凭据的窗口请求 PIN，请选择 **“更多选择”**，然后选择 **“使用其他帐户”**。
    1. 此时会打开一个“远程桌面连接”窗口，显示“无法验证远程计算机的身份。仍要连接吗?”选择 **“是”**。
    1. 现已连接到 Vm，向学员强调：在本例中，你能够连接到 Vm，因为创建的入站流量规则允许入站流量通过 RDP 流入 VM。

1. 现在测试出站 NSG 规则
    1. 在 VM 中打开 Edge 浏览器。
    1. 输入 **“https://www.bing.com”** 该页面应该不会显示。备注：如果你能够连接到 Internet，并已验证正确设置了出站规则的所有参数，则很可能是因为规则需要几分钟才能生效。请等候几分钟，然后重试。

1. 通过选择显示 IP 地址的页面顶部中心的 **“X”**，关闭远程桌面连接。此时会出现一个弹出窗口，显示“将断开远程会话连接”。选择 **“确定”**。

1. 选择页面顶部的蓝色栏上的 **“Microsoft Azure”**，返回到 Azure 门户的主页。

#### 清除
**重要说明**：在此任务中，你需要删除资源组及其包含的所有资源。   这对于避免产生额外费用至关重要。

1. 在浏览器中打开“SC900-WinVM - Microsoft Azure”选项卡。

1. 在页面左上角选择 **“所有服务”**。

1. 在显示所有服务旁边的“筛选服务”框中，输入 **“资源组”**，然后从结果中选择 **“资源组”**。

1. 选择 **“LabsSC900-RG”**。

1. 在“LabsSC900-RG”页面顶部中心选择 **“删除资源组”**。

1. 在打开的窗口中，输入资源组名称 **“LabsSC900-RG”** 以确认删除该资源组及其所有资源，然后选择页面底部的 **“删除”**。

1. 可能需要花费几分钟时间才能删除所有资源和该资源组。

#### 回顾

在本演示中，你展示了 NSG 相关信息和设置（包括将接口关联到 NSG 的过程）、默认入站和出站规则，最后演示了创建新规则的步骤。
